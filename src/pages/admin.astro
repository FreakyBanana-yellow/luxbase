---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout title="Adminbereich – Luxbase">
  <section class="max-w-6xl mx-auto px-6 py-12">
    <h1 class="text-3xl font-bold text-luxgold mb-6">🛠️ Admin-Portal</h1>

    <div id="admin-root">
      <p class="text-gray-400">Lade Daten …</p>
    </div>
  </section>

  <script type="module">
    import * as supabase_js from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const meta = document.getElementById("supabase-config");
    const supabase = supabase_js.createClient(meta.dataset.url, meta.dataset.key);
    const root = document.getElementById("admin-root");

    const lux = JSON.parse(sessionStorage.getItem("luxbase_config") || "{}");

    if (!lux?.rolle || lux.rolle !== "admin") {
      root.innerHTML = `<p class="text-red-400">❌ Zugriff verweigert. Du bist kein Admin.</p>`;
    } else {
      const { data: list, error } = await supabase
        .from("creator_config")
        .select("*")
        .order("created_at", { ascending: false });

      if (error || !list) {
        root.innerHTML = `<p class="text-red-400">❌ Fehler beim Laden: ${error?.message || "Unbekannter Fehler"}</p>`;
        return;
      }

      root.innerHTML = `
        <input type="text" id="searchInput" placeholder="🔍 Suche nach Name, Mail oder ID …"
               class="w-full px-4 py-2 mb-6 rounded bg-zinc-900 border border-luxgray text-white" />

        <div class="overflow-auto">
          <table class="w-full text-sm border border-luxgray">
            <thead class="bg-zinc-800 text-luxgold text-left">
              <tr>
                <th class="p-2">Name</th>
                <th class="p-2">Rolle</th>
                <th class="p-2">Pakete</th>
                <th class="p-2">E-Mail</th>
                <th class="p-2">Letzte Aktivität</th>
                <th class="p-2">Notiz</th>
              </tr>
            </thead>
            <tbody id="adminTableBody" class="text-gray-300"></tbody>
          </table>
        </div>
      `;

      const tbody = document.getElementById("adminTableBody");
      const input = document.getElementById("searchInput");

      function renderRows(data) {
        tbody.innerHTML = data.map(row => {
          const pakete = [];
          if (row.has_vipbot) pakete.push("🤖 VIP");
          if (row.has_vault) pakete.push("📁 Vault");
          if (row.bot_paket) pakete.push(`🎁 ${row.bot_paket}`);

          return `
            <tr class="border-t border-zinc-700">
              <td class="p-2 font-semibold text-white">${row.creator_name || "?"}</td>
              <td class="p-2">${row.rolle}</td>
              <td class="p-2">${pakete.join(", ") || "-"}</td>
              <td class="p-2"><a href="mailto:${row.email}" class="text-luxgold hover:underline">${row.email}</a></td>
              <td class="p-2">${row.updated_at ? new Date(row.updated_at).toLocaleString() : "-"}</td>
              <td class="p-2">
                <textarea data-id="${row.creator_id}" class="admin-note w-full bg-zinc-800 text-white text-sm border border-zinc-600 p-1 rounded">${row.admin_note || ""}</textarea>
              </td>
            </tr>
          `;
        }).join("");
      }

      renderRows(list);

      input.addEventListener("input", () => {
        const keyword = input.value.toLowerCase();
        const filtered = list.filter(row =>
          (row.creator_name || "").toLowerCase().includes(keyword) ||
          (row.email || "").toLowerCase().includes(keyword) ||
          (row.creator_id || "").toLowerCase().includes(keyword)
        );
        renderRows(filtered);
      });

      tbody.addEventListener("change", async (e) => {
        if (e.target.classList.contains("admin-note")) {
          const creator_id = e.target.dataset.id;
          const note = e.target.value;

          await supabase
            .from("creator_config")
            .update({ admin_note: note })
            .match({ creator_id });
        }
      });
    }
  </script>
</BaseLayout>
