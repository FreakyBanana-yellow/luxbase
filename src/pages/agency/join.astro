---
import BaseLayout from '../../layouts/BaseLayout.astro'
import { supabase } from '../../lib/supabase'


const url = new URL(Astro.request.url)
const agency = url.searchParams.get('agency')
let message = ''


if (agency) {
const { data: { user } } = await supabase.auth.getUser()
if (!user) {
message = 'Bitte zuerst einloggen.'
} else {
const { error } = await supabase.rpc('agency_join_self', { p_agency: agency })
message = error ? `Beitritt fehlgeschlagen: ${error.message}` : 'Du bist der Agentur beigetreten.'
}
} else {
message = 'UngÃ¼ltiger Link.'
}
---
<BaseLayout title="Agentur beitreten">
<section class="max-w-xl mx-auto px-4 py-10">
<div class="p-4 rounded-xl bg-zinc-900 border border-yellow-600/30">{message}</div>
</section>
</BaseLayout>