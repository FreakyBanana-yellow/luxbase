---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
---

<DashboardLayout title="Dein Luxbase Dashboard">
  <section class="max-w-5xl mx-auto px-4 py-12 space-y-8" id="dashboard-root">
    <div class="text-center text-gray-400">Lade deine Daten ‚Ä¶</div>
  </section>

  <script type="module">
    import * as supabase_js from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    import Chart from "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";

    if (typeof window !== "undefined") {
      const main = async () => {
        const meta = document.getElementById("supabase-config");
        const supabase = supabase_js.createClient(meta.dataset.url, meta.dataset.key);
        const root = document.getElementById("dashboard-root");

        // Session pr√ºfen
        const session = await supabase.auth.getSession();
        const user = session?.data?.session?.user;

        if (!user) {
          root.innerHTML = "<p class='text-red-400 text-center'>Nicht eingeloggt.</p>";
          return;
        }

        // Konfiguration laden
        const { data: config, error: configError } = await supabase
          .from("creator_config")
          .select("*")
          .eq("creator_id", user.id)
          .single();

        if (configError || !config) {
          root.innerHTML = "<p class='text-red-400 text-center'>‚ö†Ô∏è Keine Konfiguration gefunden.</p>";
          return;
        }

        // Features aus Paket ableiten
        const paketFeatures = {
          basic: { show_selfie_gate: false, can_customize_texts: false },
          premium: { show_selfie_gate: true, can_customize_texts: true },
        };

        const lux = { ...config, ...paketFeatures[config.bot_paket || "basic"] };
        sessionStorage.setItem("luxbase_config", JSON.stringify(lux));

        // Falls kein Bot aktiv ‚Üí Hinweis
        if (!lux.bot_aktiv) {
          root.innerHTML = `
            <div class="text-center py-12 text-gray-400">
              Der VIP‚ÄëBot ist f√ºr deinen Account nicht aktiviert.
            </div>`;
          return;
        }

        // VIP User-Daten laden
        const { data: vipList, error: vipError } = await supabase
          .from("vip_user")
          .select("joined_at")
          .eq("creator_id", lux.creator_id);

        if (vipError) {
          root.innerHTML = "<p class='text-red-400'>‚ùå Fehler beim Laden der VIP-Daten.</p>";
          return;
        }

        // Monatsstatistik berechnen
        const monthlyStats = {};
        for (const user of vipList) {
          const date = new Date(user.joined_at);
          const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, "0")}`;
          monthlyStats[key] = (monthlyStats[key] || 0) + 1;
        }

        const preis = parseFloat(lux.preis_vip || 0);
        const labels = Object.keys(monthlyStats).sort();
        const values = labels.map(k => monthlyStats[k] * preis);
        const total = values.reduce((a, b) => a + b, 0).toFixed(2);

        // HTML-√úbersicht
        root.innerHTML = `
          <div>
            <h1 class="text-3xl font-bold text-luxgold mb-2">Willkommen zur√ºck, ${lux.creator_name || "Creator"}! üëã</h1>
            <p class="text-zinc-300">Paket: <span class="font-semibold text-white">${lux.bot_paket}</span></p>
          </div>

          <div class="grid md:grid-cols-3 gap-6 mt-6">
            <div class="bg-zinc-900 border border-luxgold rounded-lg p-6 shadow">
              <h2 class="text-lg font-semibold text-luxgold mb-2">üë• Aktive VIPs</h2>
              <p class="text-3xl font-bold">${vipList.length}</p>
            </div>
            <div class="bg-zinc-900 border border-luxgold rounded-lg p-6 shadow">
              <h2 class="text-lg font-semibold text-luxgold mb-2">üí∞ Gesamtumsatz</h2>
              <p class="text-3xl font-bold">‚Ç¨ ${total}</p>
            </div>
          </div>

          <div class="bg-zinc-900 mt-10 p-6 border border-luxgold rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold text-luxgold mb-4">üìà Entwicklung der VIP-Ums√§tze</h3>
            <canvas id="chart" height="100"></canvas>
          </div>
        `;

        // Chart rendern
        const ctx = document.getElementById("chart");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{
              label: "Monatsumsatz (‚Ç¨)",
              data: values,
              backgroundColor: "#facc15",
              borderRadius: 6
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
      };

      main();
    }
  </script>
</DashboardLayout>
