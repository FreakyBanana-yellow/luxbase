---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
---

<DashboardLayout title="Dein Luxbase Dashboard">
  <section class="max-w-5xl mx-auto px-4 py-12 space-y-8" id="dashboard-root">
    <div class="text-center text-gray-400">Lade deine Daten â€¦</div>
  </section>

<script type="module">
  import * as supabase_js from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
  import Chart from "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";

  if (typeof window !== "undefined") {
    const meta = document.getElementById("supabase-config");
    const supabase = supabase_js.createClient(meta.dataset.url, meta.dataset.key);
    const lux = JSON.parse(sessionStorage.getItem("luxbase_config") || "{}");
    const root = document.getElementById("dashboard-root");

    async function loadDashboard() {
      if (!lux?.creator_id || !lux?.bot_aktiv) {
        root.innerHTML = `
          <div class="text-center py-12 text-gray-400">
            Der VIPâ€‘Bot ist fÃ¼r deinen Account nicht aktiviert.
          </div>`;
        return;
      }

      const { data: vipList, error } = await supabase
        .from("vip_user")
        .select("joined_at")
        .eq("creator_id", lux.creator_id);

      if (error) {
        root.innerHTML = "<p class='text-red-400'>âŒ Fehler beim Laden der VIP-Daten.</p>";
        return;
      }

      const monthlyStats = {};
      for (const user of vipList) {
        const date = new Date(user.joined_at);
        const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, "0")}`;
        monthlyStats[key] = (monthlyStats[key] || 0) + 1;
      }

      const preis = parseFloat(lux.preis_vip || 0);
      const labels = Object.keys(monthlyStats).sort();
      const values = labels.map(k => monthlyStats[k] * preis);
      const total = values.reduce((a, b) => a + b, 0).toFixed(2);

      root.innerHTML = `
        <div>
          <h1 class="text-3xl font-bold text-luxgold mb-2">Willkommen zurÃ¼ck, ${lux.creator_name || "Creator"}! ğŸ‘‹</h1>
          <p class="text-zinc-300">Paket: <span class="font-semibold text-white">${lux.bot_paket}</span></p>
        </div>

        <div class="grid md:grid-cols-3 gap-6">
          <div class="bg-zinc-900 border border-luxgold rounded-lg p-6 shadow">
            <h2 class="text-lg font-semibold text-luxgold mb-2">ğŸ‘¥ Aktive VIPs</h2>
            <p class="text-3xl font-bold">${vipList.length}</p>
          </div>
          <div class="bg-zinc-900 border border-luxgold rounded-lg p-6 shadow">
            <h2 class="text-lg font-semibold text-luxgold mb-2">ğŸ’° Gesamtumsatz</h2>
            <p class="text-3xl font-bold">â‚¬ ${total}</p>
          </div>
        </div>

        <div class="bg-zinc-900 mt-10 p-6 border border-luxgold rounded-xl shadow-lg">
          <h3 class="text-lg font-semibold text-luxgold mb-4">ğŸ“ˆ Entwicklung der VIP-UmsÃ¤tze</h3>
          <canvas id="chart" height="100"></canvas>
        </div>
      `;

      const ctx = document.getElementById("chart");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Monatsumsatz (â‚¬)",
            data: values,
            backgroundColor: "#facc15",
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    loadDashboard();
  }
</script>
</DashboardLayout>
