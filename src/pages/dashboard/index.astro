---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import RevenueChart from "../../components/RevenueChart.jsx";
import { createClient } from "@supabase/supabase-js";

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

const luxStr = 'typeof window !== "undefined" && sessionStorage.getItem("luxbase_config")';
let lux = {};

if (Astro.request.headers.get("user-agent")?.includes("Node")) {
  // Build-Schutz
  lux = {};
} else {
  lux = JSON.parse(sessionStorage.getItem("luxbase_config") || "{}");
}

let vipList = [];
let monthlyStats = {};
let totalRevenue = 0;

if (lux?.creator_id && lux?.bot_aktiv) {
  const { data, error } = await supabase
    .from("vip_user")
    .select("joined_at")
    .eq("creator_id", lux.creator_id);

  vipList = data || [];

  for (const user of vipList) {
    const date = new Date(user.joined_at);
    const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, "0")}`;
    monthlyStats[key] = (monthlyStats[key] || 0) + 1;
  }

  const preis = parseFloat(lux.preis_vip || 0);
  totalRevenue = Object.values(monthlyStats).reduce((sum, count) => sum + (count * preis), 0);
}
---

<DashboardLayout title="Dein Luxbase Dashboard">
  {lux?.creator_id && lux?.bot_aktiv ? (
    <section class="max-w-5xl mx-auto px-4 py-12 space-y-8">
      <div>
        <h1 class="text-3xl font-bold text-luxgold mb-2">
          Willkommen zurÃ¼ck, {lux.creator_name || "Creator"}!
        </h1>
        <p class="text-zinc-300">
          Paket: <span class="font-semibold text-white">{lux.bot_paket}</span>
        </p>
      </div>

      <div class="grid md:grid-cols-3 gap-6">
        <div class="bg-zinc-900 border border-luxgold rounded-lg p-6 shadow">
          <h2 class="text-lg font-semibold text-luxgold mb-2">ðŸ‘¥ Aktive VIPs</h2>
          <p class="text-3xl font-bold">{vipList.length}</p>
        </div>
        <div class="bg-zinc-900 border border-luxgold rounded-lg p-6 shadow">
          <h2 class="text-lg font-semibold text-luxgold mb-2">ðŸ’° Gesamtumsatz</h2>
          <p class="text-3xl font-bold">â‚¬ {totalRevenue.toFixed(2)}</p>
        </div>
      </div>

      <RevenueChart 
        data={Object.entries(monthlyStats).map(([month, count]) => ({
          month,
          amount: count * parseFloat(lux.preis_vip || 0),
        }))}
      />
    </section>
  ) : (
    <section class="text-center py-12 text-gray-400">
      Der VIP-Bot ist fÃ¼r deinen Account nicht aktiviert.
    </section>
  )}
</DashboardLayout>
