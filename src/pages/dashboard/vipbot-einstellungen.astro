---
import DashboardLayout from "../../layouts/DashboardLayout.astro";

/** Fix: ENV einmal serverseitig lesen und ins DOM schreiben */
const BOT_USERNAME = "Luxbot";
const BOT_API_BASE = import.meta.env.PUBLIC_BOT_API_BASE || ""; // <- kommt aus Netlify
---

<DashboardLayout title="VIPâ€‘Bot Einstellungen">
  <!-- Ãœbergabe an Script via Data-Attr -->
  <div id="lux-meta" data-bot={BOT_USERNAME} data-bot-api={BOT_API_BASE} class="hidden"></div>

  <section class="max-w-3xl mx-auto px-4 py-6 pb-28 relative space-y-6">
    <div id="statusBox" class="hidden bg-black/60 border border-luxgray rounded-2xl p-4 text-sm text-white/80"></div>

    <form id="botForm" class="space-y-5">
      <!-- Basis -->
      <div class="bg-black/60 border border-luxgray rounded-2xl p-4 space-y-4">
        <h2 class="text-luxgold text-lg font-semibold">Basis</h2>
        <div class="grid grid-cols-2 gap-3">
          <label class="block">
            <span class="text-sm text-white/70">Preis (â‚¬)</span>
            <input id="preis" type="number" step="1" min="0" class="mt-1 w-full bg-black/40 border border-luxgray rounded-xl px-3 py-2" placeholder="29" />
          </label>
          <label class="block">
            <span class="text-sm text-white/70">VIPâ€‘Dauer (Tage)</span>
            <input id="vip_days" type="number" step="1" min="1" class="mt-1 w-full bg-black/40 border border-luxgray rounded-xl px-3 py-2" placeholder="30" />
          </label>
        </div>
      </div>

      <!-- Gruppe -->
      <div class="bg-black/60 border border-luxgray rounded-2xl p-4 space-y-4">
        <h2 class="text-luxgold text-lg font-semibold">Gruppe</h2>

        <label class="block">
          <span class="text-sm text-white/70">Gruppenâ€‘Link (Fallback, statisch)</span>
          <input id="gruppe_link" class="mt-1 w-full bg-black/40 border border-luxgray rounded-xl px-3 py-2" placeholder="https://t.me/+abcdef..." />
        </label>

        <label class="block">
          <span class="text-sm text-white/70">Gruppenâ€‘Chatâ€‘ID (automatisch nach â€Gruppe verbindenâ€œ)</span>
          <input id="group_chat_id" disabled class="mt-1 w-full bg-black/20 border border-luxgray/60 rounded-xl px-3 py-2" placeholder="-1001234567890" />
        </label>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button type="button" class="w-full border border-luxgray rounded-xl py-3" onclick="window.lux.copyStart()">Startâ€‘Link kopieren</button>
          <button type="button" class="w-full bg-luxgold/90 text-black font-semibold rounded-xl py-3" onclick="window.lux.bindGroup()">Gruppe verbinden</button>
        </div>

        <!-- Previews -->
        <div class="text-xs text-white/60 space-y-2">
          <div>Startâ€‘Link: <a id="previewStart" class="underline break-all" target="_blank" rel="noreferrer">â€”</a></div>
          <div>Startgroupâ€‘Link: <a id="previewGroup" class="underline break-all" target="_blank" rel="noreferrer">â€”</a></div>
          <div class="mt-2">Zum Kopieren:</div>
          <input id="previewStartInput" readonly class="w-full bg-black/30 border border-luxgray rounded-lg px-2 py-1 text-[12px] select-all" />
          <input id="previewGroupInput" readonly class="w-full bg-black/30 border border-luxgray rounded-lg px-2 py-1 text-[12px] select-all" />
        </div>
      </div>

      <!-- Stripe -->
      <div class="bg-black/60 border border-luxgray rounded-2xl p-4 space-y-4">
        <h2 class="text-luxgold text-lg font-semibold">Stripe</h2>
        <label class="block">
          <span class="text-sm text-white/70">Stripe Price ID (optional â€“ sonst Preis von oben)</span>
          <input id="stripe_price_id" class="mt-1 w-full bg-black/40 border border-luxgray rounded-xl px-3 py-2" placeholder="price_123..." />
        </label>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button id="stripeBtn" type="button" class="w-full bg-luxgold/90 text-black font-semibold rounded-xl py-3" onclick="window.lux.connectStripe()">Stripe verbinden</button>
          <button type="button" class="w-full border border-luxgray rounded-xl py-3" onclick="window.lux.refresh()">Status prÃ¼fen</button>
        </div>

        <p id="stripeStatus" class="text-xs text-white/60"></p>
      </div>

      <!-- Texte -->
      <div class="bg-black/60 border border-luxgray rounded-2xl p-4 space-y-4">
        <h2 class="text-luxgold text-lg font-semibold">Texte</h2>
        <label class="block">
          <span class="text-sm text-white/70">Welcomeâ€‘Text</span>
          <textarea id="welcome_text" rows="3" class="mt-1 w-full bg-black/40 border border-luxgray rounded-xl px-3 py-2" placeholder="ğŸ‘‹ Willkommen im VIP! ..."></textarea>
        </label>
        <label class="block">
          <span class="text-sm text-white/70">Regelnâ€‘Text</span>
          <textarea id="regeln_text" rows="3" class="mt-1 w-full bg-black/40 border border-luxgray rounded-xl px-3 py-2" placeholder="ğŸ“œ Regeln ..."></textarea>
        </label>
      </div>

      <div class="flex items-center gap-3">
        <button type="button" class="flex-1 bg-luxgold/90 text-black font-semibold rounded-xl py-3" onclick="window.lux.save()">Speichern</button>
        <button type="button" class="px-4 py-3 border border-luxgray rounded-xl" onclick="window.lux.refresh()">Neu laden</button>
      </div>

      <p id="hint" class="text-xs text-white/60"></p>
    </form>
  </section>

  <style is:global>
    #botForm, #botForm * { pointer-events: auto; }
  </style>

  <!-- Fallback: zeigt was an, falls Modul nicht lÃ¤dt -->
  <script>
    window.lux = window.lux || {
      save(){ alert("Aktion (Fallback). Wenn das so bleibt, lÃ¤dt das Hauptâ€‘Script nicht."); },
      refresh(){ location.reload(); },
      copyStart(){ alert("Startâ€‘Link steht im Feld â€“ bitte manuell kopieren."); },
      bindGroup(){ alert("Nutze den Startgroupâ€‘Link unten direkt."); },
      connectStripe(){ alert("Stripe benÃ¶tigt PUBLIC_BOT_API_BASE im Frontend."); }
    };
  </script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    /** Read ENV & Meta aus DOM (statt import.meta.env im Browser) */
    const META = document.getElementById("lux-meta");
    const BOT = META?.dataset?.bot || "Luxbot";
    const BOT_API = META?.dataset?.botApi || "";   // <- **Fix** hier!

    const $ = (id) => document.getElementById(id);
    const setStatus = (msg, ok=true) => {
      const box = $("statusBox");
      if (!box) return;
      box.classList.remove("hidden");
      box.textContent = msg;
      box.classList.toggle("border-green-600", ok);
      box.classList.toggle("border-red-600", !ok);
    };

    // Supabase init (aus Layout bereitgestellt)
    const meta = document.getElementById("supabase-config");
    if (!meta?.dataset?.url || !meta?.dataset?.key) {
      $("hint").textContent = "âŒ Supabaseâ€‘Konfiguration fehlt. (Layout prÃ¼fen)";
      throw new Error("supabase-config-missing");
    }
    const supabase = createClient(meta.dataset.url, meta.dataset.key);

    const fields = ["preis","vip_days","gruppe_link","group_chat_id","stripe_price_id","welcome_text","regeln_text"];

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { window.location.href = "/"; throw new Error("not-auth"); }

    const startLink = () => `https://t.me/${BOT}?start=${encodeURIComponent("creator_"+user.id)}`;
    const groupLink = () => `https://t.me/${BOT}?startgroup=${encodeURIComponent("creator_"+user.id)}`;
    const stripeRedirect = () => `${BOT_API}/api/stripe/connect-redirect?creator_id=${encodeURIComponent(user.id)}`;

    function updatePreviews() {
      const s = startLink(), g = groupLink();
      $("previewStart").href = s; $("previewStart").textContent = s;
      $("previewGroup").href = g; $("previewGroup").textContent = g;
      $("previewStartInput").value = s;
      $("previewGroupInput").value = g;

      // Stripe-Button als echter Link nutzbar
      const btn = document.getElementById("stripeBtn");
      if (btn) {
        let wrap = btn.closest("a.lx-linkwrap");
        if (!wrap) {
          wrap = document.createElement("a");
          wrap.className = "lx-linkwrap";
          wrap.target = "_blank"; wrap.rel = "noreferrer";
          btn.parentNode.insertBefore(wrap, btn);
          wrap.appendChild(btn);
        }
        wrap.href = BOT_API ? stripeRedirect() : "#";
      }
    }

    async function loadCfg() {
      const { data, error } = await supabase
        .from("creator_config")
        .select(fields.join(",") + ", stripe_account_id")
        .eq("creator_id", user.id)
        .maybeSingle();

      if (error) setStatus("âŒ Konnte Einstellungen nicht laden.", false);

      if (data) {
        for (const k of fields) if ($(k)) $(k).value = (data[k] ?? "");
        if (data.group_chat_id) setStatus(`âœ… Gruppe verbunden (Chat ID: ${data.group_chat_id}). Bot sollte Admin sein.`);
        else setStatus("âš ï¸ Keine Gruppe verbunden. Nutze â€Gruppe verbindenâ€œ.", false);

        $("stripeStatus").textContent = data.stripe_account_id
          ? `âœ… Stripe verbunden (Account: ${data.stripe_account_id}).`
          : "âš ï¸ Stripe noch nicht verbunden.";
      } else {
        for (const k of fields) if ($(k)) $(k).value = "";
        setStatus("â„¹ï¸ Noch keine Einstellungen gespeichert. Bitte ausfÃ¼llen und speichern.", false);
        $("stripeStatus").textContent = "âš ï¸ Stripe noch nicht verbunden.";
      }
      updatePreviews();
    }

    window.lux = {
      async save(){
        const payload = { creator_id: user.id };
        for (const k of fields) payload[k] = $(k)?.value ?? null;
        payload.preis = Number(payload.preis || 0);
        payload.vip_days = Number(payload.vip_days || 30);

        const { error } = await supabase.from("creator_config").upsert(payload, { onConflict: "creator_id" });
        $("hint").textContent = error ? "âŒ Speichern fehlgeschlagen." : "âœ… Gespeichert.";
        if (!error) await loadCfg();
      },
      async refresh(){ await loadCfg(); $("hint").textContent = "ğŸ”„ Aktualisiert."; },
      async copyStart(){
        const s = startLink();
        try { await navigator.clipboard.writeText(s); $("hint").textContent = "ğŸ”— Startâ€‘Link kopiert: " + s; }
        catch { $("previewStartInput").select(); document.execCommand("copy"); $("hint").textContent = "ğŸ”— Markiert â€“ bitte manuell kopieren."; }
      },
      bindGroup(){
        const g = groupLink();
        window.open(g, "_blank");
        $("hint").textContent = "Ã–ffne Telegram â†’ wÃ¤hle die Gruppe â†’ Bot starten â†’ Adminâ€‘Rechte geben.";
      },
      connectStripe(){
        if (!BOT_API) { alert("PUBLIC_BOT_API_BASE fehlt im Frontend."); return; }
        window.location.href = stripeRedirect();
      }
    };
    <button id="linkTelegramBtn"
  type="button"
  class="w-full bg-luxgold/90 text-black font-semibold rounded-xl py-3">
  Telegram verbinden
</button>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
  const meta = document.getElementById("supabase-config");
  const supabase = createClient(meta.dataset.url, meta.dataset.key);

  const { data: { user } } = await supabase.auth.getUser();
  const BOT_USERNAME = "Luxbot";

  document.getElementById("linkTelegramBtn")?.addEventListener("click", () => {
    if (!user?.id) return alert("Nicht eingeloggt.");
    const link = `https://t.me/${BOT_USERNAME}?start=${encodeURIComponent("link_creator_"+user.id)}`;
    window.open(link, "_blank");
  });
</script>

    await loadCfg();
    setStatus("âœ… Seite geladen. Aktionen aktiv.");
  </script>
</DashboardLayout>
