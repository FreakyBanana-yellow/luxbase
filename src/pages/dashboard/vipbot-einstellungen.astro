---
import DashboardLayout from "../../layouts/DashboardLayout.astro";

/** Fester Telegram‑Bot Username (ohne @) */
const BOT_USERNAME = "Luxbot";
---

<DashboardLayout title="VIP‑Bot Einstellungen">
  <section id="vip-settings-root" class="max-w-3xl mx-auto px-4 py-6 pb-28 relative z-[20] space-y-6 pointer-events-auto">
    <!-- Status -->
    <div id="statusBox" class="hidden bg-black/60 border border-luxgray rounded-2xl p-4 text-sm text-white/80"></div>

    <form id="botForm" class="space-y-5">
      <!-- Basis -->
      <div class="bg-black/60 border border-luxgray rounded-2xl p-4 space-y-4">
        <h2 class="text-luxgold text-lg font-semibold">Basis</h2>

        <div class="grid grid-cols-2 gap-3">
          <label class="block">
            <span class="text-sm text-white/70">Preis (€)</span>
            <input id="preis" type="number" inputmode="numeric" step="1" min="0"
              class="mt-1 w-full bg-black/40 border border-luxgray rounded-xl px-3 py-2"
              placeholder="29" />
          </label>
          <label class="block">
            <span class="text-sm text-white/70">VIP‑Dauer (Tage)</span>
            <input id="vip_days" type="number" inputmode="numeric" step="1" min="1"
              class="mt-1 w-full bg-black/40 border border-luxgray rounded-xl px-3 py-2"
              placeholder="30" />
          </label>
        </div>
      </div>

      <!-- Gruppe -->
      <div class="bg-black/60 border border-luxgray rounded-2xl p-4 space-y-4">
        <h2 class="text-luxgold text-lg font-semibold">Gruppe</h2>

        <label class="block">
          <span class="text-sm text-white/70">Gruppen‑Link (Fallback, statisch)</span>
          <input id="gruppe_link"
            class="mt-1 w-full bg-black/40 border border-luxgray rounded-xl px-3 py-2"
            placeholder="https://t.me/+abcdef..." />
        </label>

        <label class="block">
          <span class="text-sm text-white/70">Gruppen‑Chat‑ID (wird automatisch gesetzt, wenn du „Gruppe verbinden“ nutzt)</span>
          <input id="group_chat_id" disabled
            class="mt-1 w-full bg-black/20 border border-luxgray/60 rounded-xl px-3 py-2"
            placeholder="-1001234567890" />
        </label>

        <!-- Button-Zeile: z-max + pointer-events erzwingen -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 relative z-[9999] pointer-events-auto">
          <button id="copyStartLinkBtn" type="button"
            class="w-full border border-luxgray rounded-xl py-3 cursor-pointer">Start‑Link kopieren</button>
          <button id="bindGroupBtn" type="button"
            class="w-full bg-luxgold/90 text-black font-semibold rounded-xl py-3 cursor-pointer">Gruppe verbinden</button>
        </div>

        <!-- Live-Preview der Links -->
        <div class="text-xs text-white/60 space-y-1">
          <div>Start‑Link Vorschau: <span id="previewStart" class="text-white/80 break-all">—</span></div>
          <div>Startgroup‑Link Vorschau: <span id="previewGroup" class="text-white/80 break-all">—</span></div>
        </div>

        <p class="text-xs text-white/60 leading-5">
          <b>So verbindest du die Gruppe:</b> Tippe auf „Gruppe verbinden“ → Telegram öffnet „Bot zu Gruppe hinzufügen“. Wähle deine VIP‑Gruppe,
          bestätige den Start. Der Bot speichert automatisch die <i>group_chat_id</i>. Gib dem Bot Admin‑Rechte,
          damit Einladungen & Kicks funktionieren.
        </p>
      </div>

      <!-- Stripe -->
      <div class="bg-black/60 border border-luxgray rounded-2xl p-4 space-y-4">
        <h2 class="text-luxgold text-lg font-semibold">Stripe</h2>

        <label class="block">
          <span class="text-sm text-white/70">Stripe Price ID (optional – sonst wird der Preis von oben verwendet)</span>
          <input id="stripe_price_id"
            class="mt-1 w-full bg-black/40 border border-luxgray rounded-xl px-3 py-2"
            placeholder="price_123..." />
        </label>

        <!-- Button-Zeile: z-max + pointer-events erzwingen -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 relative z-[9999] pointer-events-auto">
          <button id="connectStripeBtn" type="button"
            class="w-full bg-luxgold/90 text-black font-semibold rounded-xl py-3 cursor-pointer">
            Stripe verbinden
          </button>
          <button id="refreshStripeBtn" type="button"
            class="w-full border border-luxgray rounded-xl py-3 cursor-pointer">
            Status prüfen
          </button>
        </div>

        <p id="stripeStatus" class="text-xs text-white/60"></p>
      </div>

      <!-- Texte -->
      <div class="bg-black/60 border border-luxgray rounded-2xl p-4 space-y-4">
        <h2 class="text-luxgold text-lg font-semibold">Texte</h2>

        <label class="block">
          <span class="text-sm text-white/70">Welcome‑Text</span>
          <textarea id="welcome_text" rows="3"
            class="mt-1 w-full bg-black/40 border border-luxgray rounded-xl px-3 py-2"
            placeholder="👋 Willkommen im VIP! ..."></textarea>
        </label>

        <label class="block">
          <span class="text-sm text-white/70">Regeln‑Text</span>
          <textarea id="regeln_text" rows="3"
            class="mt-1 w-full bg-black/40 border border-luxgray rounded-xl px-3 py-2"
            placeholder="📜 Regeln ..."></textarea>
        </label>
      </div>

      <!-- Actions -->
      <div class="flex items-center gap-3">
        <button id="saveBtn" type="submit"
          class="flex-1 bg-luxgold/90 text-black font-semibold rounded-xl py-3 cursor-pointer">Speichern</button>
        <button id="refreshBtn" type="button"
          class="px-4 py-3 border border-luxgray rounded-xl cursor-pointer">Neu laden</button>
      </div>

      <p id="hint" class="text-xs text-white/60"></p>
    </form>
  </section>

  <!-- Hard-Fixes gegen Overlays -->
  <style is:global>
    #vip-settings-root, #vip-settings-root * { pointer-events: auto; }
    /* Falls eine Bottom-Nav überlappt, z.B. .mobile-nav: */
    .mobile-nav, .app-bottom-bar, .bottom-nav { z-index: 30; } /* Buttons sind z-9999 */
  </style>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const BOT_USERNAME = ${JSON.stringify(BOT_USERNAME)};
    const BOT_API = import.meta.env.PUBLIC_BOT_API_BASE || ""; // z.B. https://luxentry.onrender.com

    const $ = (id) => document.getElementById(id);
    const elCopy    = $("copyStartLinkBtn");
    const elGroup   = $("bindGroupBtn");
    const elConnect = $("connectStripeBtn");
    const elRStripe = $("refreshStripeBtn");

    function setStatus(msg, ok=true) {
      const box = $("statusBox");
      if (!box) return;
      box.classList.remove("hidden");
      box.textContent = msg;
      box.classList.toggle("border-green-600", ok);
      box.classList.toggle("border-red-600", !ok);
    }

    // 🔎 Diagnose: Wenn ein Klick NICHT auf dem Button ankommt, markieren wir den Blocker rot
    function markBlockerOnNextClick(btn) {
      btn?.addEventListener("click", (ev) => {
        const x = ev.clientX, y = ev.clientY;
        const top = document.elementFromPoint(x, y);
        if (top && top !== btn && !btn.contains(top)) {
          top.style.outline = "2px solid red";
          top.style.outlineOffset = "2px";
          setStatus("⚠️ Ein Element blockiert Klicks (rot markiert). Klassen: " + (top.className || "(keine)"), false);
          console.warn("Blocking element:", top);
        }
      }, { once: true });
    }
    [elCopy, elGroup, elConnect, elRStripe].forEach(markBlockerOnNextClick);

    // Supabase init
    const meta = document.getElementById("supabase-config");
    const supabase = createClient(meta.dataset.url, meta.dataset.key);

    const fields = ["preis","vip_days","gruppe_link","group_chat_id","stripe_price_id","welcome_text","regeln_text"];

    // Auth
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { window.location.href = "/"; throw new Error("not-auth"); }

    const startLink = () => `https://t.me/${BOT_USERNAME}?start=${encodeURIComponent("creator_"+user.id)}`;
    const groupLink = () => `https://t.me/${BOT_USERNAME}?startgroup=${encodeURIComponent("creator_"+user.id)}`;

    function updatePreviews() {
      const pS = $("previewStart"), pG = $("previewGroup");
      if (pS) pS.textContent = startLink();
      if (pG) pG.textContent = groupLink();
    }

    async function loadCfg() {
      const { data, error } = await supabase
        .from("creator_config")
        .select(fields.join(",") + ", stripe_account_id, application_fee_pct")
        .eq("creator_id", user.id)
        .maybeSingle();

      if (error) setStatus("❌ Konnte Einstellungen nicht laden.", false);

      if (data) {
        for (const k of fields) if ($(k)) $(k).value = (data[k] ?? "");
        if (data.group_chat_id) {
          setStatus(`✅ Gruppe verbunden (Chat ID: ${data.group_chat_id}). Bot sollte Admin sein.`);
        } else {
          setStatus("⚠️ Keine Gruppe verbunden. Klicke „Gruppe verbinden“.", false);
        }
        const s = $("stripeStatus");
        if (s) s.textContent = data.stripe_account_id
          ? `✅ Stripe verbunden (Account: ${data.stripe_account_id}).`
          : "⚠️ Stripe noch nicht verbunden.";
      } else {
        for (const k of fields) if ($(k)) $(k).value = "";
        setStatus("ℹ️ Noch keine Einstellungen gespeichert. Bitte ausfüllen und speichern.", false);
        const s = $("stripeStatus");
        if (s) s.textContent = "⚠️ Stripe noch nicht verbunden.";
      }
      updatePreviews();
    }

    await loadCfg();

    // Speichern
    $("botForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      $("saveBtn").disabled = true;

      const payload = { creator_id: user.id };
      for (const k of fields) payload[k] = $(k)?.value ?? null;
      payload.preis = Number(payload.preis || 0);
      payload.vip_days = Number(payload.vip_days || 30);

      const { error } = await supabase
        .from("creator_config")
        .upsert(payload, { onConflict: "creator_id" });

      $("saveBtn").disabled = false;
      $("hint").textContent = error ? "❌ Speichern fehlgeschlagen." : "✅ Gespeichert.";
      if (!error) await loadCfg();
    });

    // Start‑Link (DM)
    elCopy?.addEventListener("click", async () => {
      const link = startLink();
      try { await navigator.clipboard.writeText(link); } catch {}
      $("hint").textContent = "🔗 Start‑Link kopiert: " + link;
    });

    // Gruppe verbinden (startgroup Flow)
    elGroup?.addEventListener("click", () => {
      const link = groupLink();
      window.open(link, "_blank");
      $("hint").textContent = "Öffne Telegram → wähle die Gruppe → Bot starten → Admin‑Rechte geben.";
    });

    // Stripe verbinden (Connect Express Onboarding)
    elConnect?.addEventListener("click", async () => {
      if (!BOT_API) { alert("API‑Basis (PUBLIC_BOT_API_BASE) ist nicht konfiguriert."); return; }
      try {
        const r = await fetch(`${BOT_API}/api/stripe/connect-link?creator_id=${encodeURIComponent(user.id)}`);
        const { url, error } = await r.json();
        if (error || !url) throw new Error(error || "No URL");
        window.location.href = url;
      } catch {
        alert("Stripe‑Connect Fehler. Bitte später erneut versuchen.");
      }
    });

    // Stripe Status prüfen/aktualisieren
    elRStripe?.addEventListener("click", loadCfg);

    // Neu laden
    $("refreshBtn").addEventListener("click", loadCfg);
  </script>
</DashboardLayout>
