---
import Layout from "../layouts/BaseLayout.astro";
---

<Layout title="Registrieren – Luxbase">
  <!-- DEIN REGISTRIERUNGSCODE STARTET HIER -->
  <section class="max-w-xl mx-auto px-4 py-16">
    <h1 class="text-3xl font-bold text-luxgold mb-6 text-center">Registrieren</h1>
    
    <form id="registerForm" class="grid gap-6">
      <input type="text" id="name" placeholder="Name" class="px-4 py-2 rounded bg-black border border-gray-600 text-white" required />
      
      <input type="email" id="email" placeholder="E-Mail" class="px-4 py-2 rounded bg-black border border-gray-600 text-white" required />
      
      <div>
        <input type="password" id="password" placeholder="Passwort" class="px-4 py-2 w-full rounded bg-black border border-gray-600 text-white" required />
        <p id="pwRules" class="text-sm mt-2 text-luxgold hidden">
          ✅ Mind. 8 Zeichen<br />
          ✅ 1 Zahl<br />
          ✅ 1 Großbuchstabe<br />
          ✅ 1 Sonderzeichen
        </p>
      </div>
      
      <div>
        <input type="password" id="confirmPassword" placeholder="Passwort wiederholen" class="px-4 py-2 w-full rounded bg-black border border-gray-600 text-white" required />
        <p id="pwMismatch" class="text-sm mt-1 text-red-500 hidden">Passwörter stimmen nicht überein</p>
      </div>

      <select id="role" class="px-4 py-2 rounded bg-black border border-gray-600 text-white" required>
        <option value="">Wähle deine Rolle</option>
        <option value="creator">Creator / Model</option>
        <option value="agentur">Agentur</option>
      </select>

      <button type="submit" class="w-full bg-luxgold text-black font-semibold py-2 rounded hover:bg-yellow-400 transition">
        Registrieren
      </button>
    </form>

    <p id="regMsg" class="text-center text-sm mt-4 text-red-400"></p>
  </section>

  <script type="module">
    const pw = document.getElementById("password");
    const pwRules = document.getElementById("pwRules");
    const confirmPw = document.getElementById("confirmPassword");
    const mismatch = document.getElementById("pwMismatch");
    const regMsg = document.getElementById("regMsg");

    function checkPasswordStrength(val) {
      const minLength = val.length >= 8;
      const hasNumber = /\d/.test(val);
      const hasUpper = /[A-Z]/.test(val);
      const hasSpecial = /[!@#$%^&*]/.test(val);
      return minLength && hasNumber && hasUpper && hasSpecial;
    }

    pw.addEventListener("input", () => {
      pwRules.classList.remove("hidden");
      if (checkPasswordStrength(pw.value)) {
        pwRules.classList.add("text-green-500");
        pwRules.classList.remove("text-luxgold");
      } else {
        pwRules.classList.add("text-luxgold");
        pwRules.classList.remove("text-green-500");
      }
    });

    confirmPw.addEventListener("input", () => {
      mismatch.classList.toggle("hidden", pw.value === confirmPw.value);
    });

    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = pw.value.trim();
      const role = document.getElementById("role").value;

      if (password !== confirmPw.value.trim()) {
        mismatch.classList.remove("hidden");
        return;
      }

      const { data, error } = await window.supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            name,
            role,
          }
        }
      });

      if (error) {
        regMsg.textContent = error.message;
      } else {
        regMsg.classList.remove("text-red-400");
        regMsg.classList.add("text-green-500");
        regMsg.textContent = "Bitte bestätige deine E-Mail – dann geht's weiter.";
      }
    });
  </script>
</Layout>
