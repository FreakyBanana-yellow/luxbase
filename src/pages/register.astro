---
import Layout from "../layouts/BaseLayout.astro";

/*  Titel â€“ MUSS gesetzt sein, sonst meckert Astro                         */
title: "Registrieren â€“ Luxbase";
---

<Layout {title}>
  <form
    id="registerForm"
    class="bg-black border border-luxgold rounded-xl p-8 w-full max-w-md mx-auto my-12"
  >
    <h1 class="text-2xl font-bold text-center text-luxgold mb-6">
      Registrieren
    </h1>

    <input
      id="name"
      type="text"
      placeholder="Dein Name"
      required
      class="w-full px-4 py-2 mb-4 rounded bg-gray-800 border border-gray-600"
    />

    <input
      id="email"
      type="email"
      placeholder="E-Mail"
      required
      class="w-full px-4 py-2 mb-4 rounded bg-gray-800 border border-gray-600"
    />

    <select
      id="role"
      required
      class="w-full px-4 py-2 mb-4 rounded bg-gray-800 border border-gray-600"
    >
      <option value="creator">Creator / Model</option>
      <option value="agentur">Agentur</option>
    </select>

    <!-- Passwort & Toggle -->
    <div class="relative mb-2">
      <input
        id="password"
        type="password"
        placeholder="Passwort"
        required
        class="w-full px-4 py-2 pr-10 rounded bg-gray-800 border border-gray-600"
      />
      <button
        type="button"
        id="togglePw"
        class="absolute right-2 top-2 text-yellow-400"
      >
        ğŸ‘
      </button>
    </div>

    <div class="relative mb-2">
      <input
        id="confirmPassword"
        type="password"
        placeholder="Passwort wiederholen"
        required
        class="w-full px-4 py-2 pr-10 rounded bg-gray-800 border border-gray-600"
      />
      <button
        type="button"
        id="toggleConfirm"
        class="absolute right-2 top-2 text-yellow-400"
      >
        ğŸ‘
      </button>
    </div>

    <!-- Live-Feedback -->
    <ul id="passwordCriteria" class="text-sm mb-4">
      <li id="len"   class="text-red-400">â€¢ Mind. 8 Zeichen</li>
      <li id="upper" class="text-red-400">â€¢ Mind. 1 GroÃŸbuchstabe</li>
      <li id="lower" class="text-red-400">â€¢ Mind. 1 Kleinbuchstabe</li>
      <li id="num"   class="text-red-400">â€¢ Mind. 1 Zahl</li>
      <li id="match" class="text-red-400">â€¢ Beide PasswÃ¶rter mÃ¼ssen Ã¼bereinstimmen</li>
    </ul>

    <button
      type="submit"
      class="w-full bg-luxgold text-black font-bold py-2 rounded hover:bg-yellow-400 transition"
    >
      Registrieren
    </button>

    <p id="error"   class="text-red-400 text-sm mt-4 text-center"></p>
    <p id="success" class="text-green-400 text-sm mt-4 text-center"></p>
  </form>

  <!-- Formular-/Passwort- & Supabase-Logik -->
  <script type="module">
    const pw       = document.getElementById("password");
    const confirm  = document.getElementById("confirmPassword");
    const errorEl  = document.getElementById("error");
    const successEl= document.getElementById("success");

    const crit = {
      len  : document.getElementById("len"),
      upper: document.getElementById("upper"),
      lower: document.getElementById("lower"),
      num  : document.getElementById("num"),
      match: document.getElementById("match"),
    };

    function mark(el, ok) {
      el.classList.toggle("text-green-400", ok);
      el.classList.toggle("text-red-400", !ok);
    }

    function valid() {
      const v   = pw.value;
      const len = v.length >= 8;
      const up  = /[A-Z]/.test(v);
      const low = /[a-z]/.test(v);
      const num = /\d/.test(v);
      const mat = v === confirm.value && v !== "";

      mark(crit.len,   len);
      mark(crit.upper, up);
      mark(crit.lower, low);
      mark(crit.num,   num);
      mark(crit.match, mat);

      return len && up && low && num && mat;
    }

    pw.addEventListener("input",     valid);
    confirm.addEventListener("input",valid);

    // Toggle sichtbar
    document.getElementById("togglePw").onclick      = () => pw.type      = pw.type      === "password" ? "text" : "password";
    document.getElementById("toggleConfirm").onclick = () => confirm.type = confirm.type === "password" ? "text" : "password";

    // Submit
    document.getElementById("registerForm").onsubmit = async (e) => {
      e.preventDefault();
      errorEl.textContent   = "";
      successEl.textContent = "";

      if (!valid()) {
        errorEl.textContent = "Passwort erfÃ¼llt nicht alle Anforderungen.";
        return;
      }

      const name  = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const role  = document.getElementById("role").value;

      const { error } = await window.supabase.auth.signUp({
        email,
        password: pw.value,
        options: { data: { name, role } }
      });

      if (error) {
        errorEl.textContent = error.message;
      } else {
        successEl.textContent = "Registrierung erfolgreich. Bitte E-Mail bestÃ¤tigen â€¦";
        setTimeout(() => (window.location.href = role === "agentur" ? "/dashboard-agentur" : "/dashboard-model"), 1800);
      }
    };
  </script>
</Layout>
